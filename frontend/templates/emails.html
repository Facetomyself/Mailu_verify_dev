{% extends "base.html" %}

{% block title %}é‚®ç®±ç®¡ç† - MailuéªŒè¯ç å¹³å°{% endblock %}

{% set current_page = 'emails' %}

{% block content %}
    <!-- åˆ›å»ºé‚®ç®±åŒºåŸŸ -->
    <section class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">â• åˆ›å»ºæ–°é‚®ç®±</h3>
        </div>
        <div class="card-content">
            <form onsubmit="createEmail(); return false;" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <div style="min-width: 150px;">
                    <select id="domainSelect" class="form-input">
                        <option value="example.com">example.com</option>
                        <option value="mailu.example">mailu.example</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">â• åˆ›å»ºé‚®ç®±</button>
            </form>
            <div id="createResult" style="margin-top: 1rem;"></div>
        </div>
    </section>

    <!-- é‚®ç®±åˆ—è¡¨ -->
    <section class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">ğŸ“¬ é‚®ç®±åˆ—è¡¨</h3>
        </div>
        <div class="card-content">
            <div id="emailContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_scripts %}
<script>
    // é¡µé¢åŠ è½½æ—¶è·å–é‚®ç®±åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', loadEmails);

    async function createEmail() {
        const domain = document.getElementById('domainSelect').value;
        const resultDiv = document.getElementById('createResult');

        resultDiv.innerHTML = '<div class="loading" style="padding: 1rem;"><div class="loading-spinner"></div> åˆ›å»ºä¸­...</div>';

        try {
            const response = await fetch('/api/emails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ domain: domain })
            });

            const data = await response.json();
            if (response.ok) {
                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: rgba(72, 187, 120, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--success-color);">
                        <div style="color: var(--success-color); font-weight: bold; margin-bottom: 0.5rem;">âœ… é‚®ç®±åˆ›å»ºæˆåŠŸ</div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--gray-800); margin-bottom: 0.25rem;">${data.email}</div>
                        <div style="color: var(--gray-600);">å¯†ç : <strong>${data.password}</strong></div>
                        <div style="color: var(--gray-600);">è¿‡æœŸæ—¶é—´: ${data.expires_at}</div>
                    </div>
                `;
                loadEmails(); // åˆ·æ–°é‚®ç®±åˆ—è¡¨
            } else {
                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: rgba(245, 101, 101, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--error-color);">
                        <div style="color: var(--error-color); font-weight: bold;">âŒ åˆ›å»ºå¤±è´¥</div>
                        <div style="color: var(--gray-600); margin-top: 0.25rem;">${data.detail || 'æœªçŸ¥é”™è¯¯'}</div>
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div style="padding: 1rem; background: rgba(245, 101, 101, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--error-color);">
                    <div style="color: var(--error-color); font-weight: bold;">âŒ åˆ›å»ºå¤±è´¥</div>
                    <div style="color: var(--gray-600); margin-top: 0.25rem;">è¯·é‡è¯•</div>
                </div>
            `;
            console.error('åˆ›å»ºé‚®ç®±å¤±è´¥:', error);
        }
    }

    async function loadEmails() {
        const container = document.getElementById('emailContainer');
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div> åŠ è½½ä¸­...</div>';

        try {
            const response = await fetch('/api/emails');
            const emails = await response.json();

            if (emails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-title">æš‚æ— é‚®ç®±</div>
                        <div class="empty-state-description">ç‚¹å‡»ä¸Šæ–¹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªä¸´æ—¶é‚®ç®±</div>
                    </div>
                `;
                return;
            }

            let html = '';
            emails.forEach(email => {
                const statusClass = email.time_remaining === 'å·²è¿‡æœŸ' ? 'status-error' : 'status-success';
                const statusText = email.time_remaining === 'å·²è¿‡æœŸ' ? 'å·²è¿‡æœŸ' : 'æ´»è·ƒ';

                html += `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-content" style="padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.25rem; font-weight: bold; color: var(--gray-800); margin-bottom: 0.5rem;">
                                        ${email.email}
                                    </div>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: var(--gray-600); font-size: 0.9rem;">
                                        <div>ğŸ“… åˆ›å»º: ${email.created_at}</div>
                                        <div>â° è¿‡æœŸ: ${email.expires_at}</div>
                                        <div>â³ å‰©ä½™: ${email.time_remaining}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <div class="status-badge ${statusClass}">${statusText}</div>
                                    <button class="btn btn-secondary" onclick="viewVerifications('${email.email}')">ğŸ“§ æŸ¥çœ‹éªŒè¯ç </button>
                                    <button class="btn btn-danger" onclick="deleteEmail('${email.email}')">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
                </div>
            `;
            console.error('åŠ è½½é‚®ç®±åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    async function viewVerifications(email) {
        window.location.href = `/verification?email=${encodeURIComponent(email)}`;
    }

    async function deleteEmail(email) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚®ç®± ${email} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
            return;
        }

        try {
            const response = await fetch(`/api/emails/${email}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const resultDiv = document.getElementById('createResult');
                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: rgba(72, 187, 120, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--success-color);">
                        <div style="color: var(--success-color); font-weight: bold;">âœ… é‚®ç®±åˆ é™¤æˆåŠŸ</div>
                        <div style="color: var(--gray-600); margin-top: 0.25rem;">${email} å·²è¢«åˆ é™¤</div>
                    </div>
                `;
                loadEmails(); // åˆ·æ–°åˆ—è¡¨
            } else {
                const error = await response.json();
                alert(`åˆ é™¤å¤±è´¥ï¼š${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            console.error('åˆ é™¤é‚®ç®±å¤±è´¥:', error);
        }
    }
</script>
{% endblock %}
