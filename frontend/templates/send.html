{% extends "base.html" %}

{% block title %}å‘é€é‚®ä»¶ - MailuéªŒè¯ç å¹³å°{% endblock %}

{% set current_page = 'send' %}

{% block content %}
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="card fade-in">
        <div class="card-header">
            <h2 class="card-title">ğŸ“¤ å‘é€é‚®ä»¶</h2>
            <p class="card-description">ä½¿ç”¨ä¸´æ—¶é‚®ç®±å‘é€é‚®ä»¶ï¼Œæ”¯æŒçº¯æ–‡æœ¬å’ŒHTMLæ ¼å¼</p>
        </div>
    </section>

    <!-- å‘é€é‚®ä»¶è¡¨å• -->
    <section class="card fade-in">
        <div class="card-content">
            <form id="sendEmailForm" onsubmit="sendEmail(event); return false;">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="required">*</span> å‘ä»¶äººé‚®ç®±
                        </label>
                        <select id="fromEmail" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©å‘ä»¶äººé‚®ç®±...</option>
                        </select>
                        <small class="form-hint">åªèƒ½ä½¿ç”¨æ´»è·ƒçš„ä¸´æ—¶é‚®ç®±ä½œä¸ºå‘ä»¶äºº</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="required">*</span> æ”¶ä»¶äººé‚®ç®±
                        </label>
                        <input type="email" id="toEmail" class="form-input" placeholder="æ”¶ä»¶äººé‚®ç®±åœ°å€" required>
                        <small class="form-hint">æ”¯æŒå¤šä¸ªæ”¶ä»¶äººï¼Œç”¨é€—å·åˆ†éš”</small>
                    </div>

                    <div class="form-group form-group-full">
                        <label class="form-label">
                            <span class="required">*</span> é‚®ä»¶ä¸»é¢˜
                        </label>
                        <input type="text" id="emailSubject" class="form-input" placeholder="è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜" required>
                    </div>

                    <div class="form-group form-group-full">
                        <label class="form-label">
                            <span class="required">*</span> é‚®ä»¶å†…å®¹
                        </label>
                        <textarea id="emailBody" class="form-input" rows="8" placeholder="è¯·è¾“å…¥é‚®ä»¶æ­£æ–‡å†…å®¹" required style="resize: vertical; min-height: 150px;"></textarea>
                        <small class="form-hint">æ”¯æŒçº¯æ–‡æœ¬å†…å®¹ï¼Œå¦‚éœ€HTMLæ ¼å¼è¯·ä½¿ç”¨ä¸“é—¨çš„HTMLé‚®ä»¶å‘é€å·¥å…·</small>
                    </div>
                </div>

                <!-- é«˜çº§é€‰é¡¹ -->
                <details class="form-advanced">
                    <summary class="form-advanced-toggle">ğŸ“‹ é«˜çº§é€‰é¡¹</summary>
                    <div class="form-advanced-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">å›å¤åœ°å€</label>
                                <input type="email" id="replyTo" class="form-input" placeholder="å¯é€‰çš„å›å¤åœ°å€">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä¼˜å…ˆçº§</label>
                                <select id="priority" class="form-input">
                                    <option value="normal">æ™®é€š</option>
                                    <option value="low">ä½</option>
                                    <option value="high">é«˜</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- å‘é€æŒ‰é’® -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºè¡¨å•
                    </button>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <span id="sendIcon">ğŸ“¤</span>
                        <span id="sendText">å‘é€é‚®ä»¶</span>
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- å‘é€å†å² -->
    <section class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">ğŸ“‹ æœ€è¿‘å‘é€è®°å½•</h3>
        </div>
        <div class="card-content">
            <div id="sendHistory">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“¤</div>
                    <div class="empty-state-title">æš‚æ— å‘é€è®°å½•</div>
                    <div class="empty-state-description">å‘é€é‚®ä»¶åä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºå‘é€å†å²</div>
                </div>
            </div>
        </div>
    </section>

    <!-- å‘é€çŠ¶æ€æç¤º -->
    <div id="sendStatus" class="status-notification" style="display: none;">
        <div class="status-content">
            <span id="statusIcon">â³</span>
            <span id="statusText">æ­£åœ¨å‘é€é‚®ä»¶...</span>
        </div>
    </div>

    <!-- SMTPé…ç½®æç¤º -->
    <div id="smtpConfigHint" class="card" style="display: none; margin-top: 2rem; border-left: 4px solid #ff9800;">
        <div class="card-header">
            <h3 class="card-title" style="color: #ff9800;">âš ï¸ SMTPé…ç½®æé†’</h3>
        </div>
        <div class="card-content">
            <p>å¦‚æœå‘é€é‚®ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š</p>
            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                <li>ç¡®ä¿SMTP_USERNAMEå’ŒSMTP_PASSWORDåœ¨.envæ–‡ä»¶ä¸­æ­£ç¡®é…ç½®</li>
                <li>SMTPç«¯å£é…ç½®ï¼š<br>
                    - ç«¯å£25ï¼šä¼ ç»ŸSMTPï¼ˆæ— åŠ å¯†ï¼‰<br>
                    - ç«¯å£587ï¼šSubmissionç«¯å£ï¼ˆæ¨èï¼ŒSTARTTLSåŠ å¯†ï¼‰<br>
                    - ç«¯å£465ï¼šSMTPSç«¯å£ï¼ˆSSL/TLSåŠ å¯†ï¼‰</li>
                <li>å‘ä»¶äººé‚®ç®±å¿…é¡»æ˜¯æœ‰æ•ˆçš„ä¸´æ—¶é‚®ç®±</li>
                <li>å¯ä»¥è¿è¡Œ <code style="background: #f5f5f5; padding: 0.2rem 0.5rem; border-radius: 3px;">python test_smtp.py</code> æµ‹è¯•SMTPé…ç½®</li>
            </ul>
            <button onclick="hideSmtpHint()" style="background: #ff9800; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">
                çŸ¥é“äº†
            </button>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    const SEND_HISTORY_KEY = 'mailu_send_history';
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
        console.log('å½“å‰URL:', window.location.href);
        console.log('åè®®:', window.location.protocol);
        console.log('ä¸»æœº:', window.location.host);

        loadAvailableEmails();
        loadSendHistory();

        // æ·»åŠ ä¸€ä¸ªç®€å•çš„æµ‹è¯•æŒ‰é’®
        const testBtn = document.createElement('button');
        testBtn.textContent = 'æµ‹è¯•APIè¿æ¥';
        testBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;';
        testBtn.onclick = testApiConnection;
        document.body.appendChild(testBtn);
    });

    // æµ‹è¯•APIè¿æ¥
    async function testApiConnection() {
        try {
            console.log('æµ‹è¯•APIè¿æ¥...');
            const response = await fetch('/api/emails');
            const data = await response.json();
            console.log('APIè¿æ¥æˆåŠŸ:', data);
            alert('APIè¿æ¥æˆåŠŸï¼é‚®ç®±æ•°é‡: ' + data.length);
        } catch (error) {
            console.error('APIè¿æ¥å¤±è´¥:', error);
            alert('APIè¿æ¥å¤±è´¥: ' + error.message);
        }
    }

    // åŠ è½½å¯ç”¨é‚®ç®±
    async function loadAvailableEmails() {
        try {
            console.log('å¼€å§‹åŠ è½½å¯ç”¨é‚®ç®±...');
            const response = await fetch('/api/emails');
            console.log('APIå“åº”çŠ¶æ€:', response.status);
            const emails = await response.json();
            console.log('è·å–åˆ°çš„é‚®ç®±åˆ—è¡¨:', emails);

            const select = document.getElementById('fromEmail');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å‘ä»¶äººé‚®ç®±...</option>';

            if (emails.length === 0) {
                select.innerHTML = '<option value="" disabled>æš‚æ— å¯ç”¨çš„é‚®ç®±ï¼Œè¯·å…ˆåˆ›å»ºä¸´æ—¶é‚®ç®±</option>';
                showStatus('âš ï¸ æš‚æ— å¯ç”¨çš„é‚®ç®±ï¼Œè¯·å…ˆåœ¨é‚®ç®±ç®¡ç†é¡µé¢åˆ›å»ºä¸´æ—¶é‚®ç®±', 'warning');
                return;
            }

            emails.forEach(email => {
                if (email.time_remaining !== 'å·²è¿‡æœŸ') {
                    const option = document.createElement('option');
                    option.value = email.email;
                    option.textContent = `${email.email} (${email.time_remaining})`;
                    select.appendChild(option);
                }
            });

            if (select.options.length === 1) {
                showStatus('âš ï¸ æ²¡æœ‰æ´»è·ƒçš„é‚®ç®±å¯ç”¨ï¼Œè¯·å…ˆåˆ›å»ºä¸´æ—¶é‚®ç®±', 'warning');
            }

        } catch (error) {
            console.error('åŠ è½½å¯ç”¨é‚®ç®±å¤±è´¥:', error);
            showStatus('âŒ åŠ è½½é‚®ç®±åˆ—è¡¨å¤±è´¥', 'error');
        }
    }

    // å‘é€é‚®ä»¶
    async function sendEmail(event) {
        event.preventDefault();

        console.log('å¼€å§‹å‘é€é‚®ä»¶...');

        const sendBtn = document.getElementById('sendBtn');
        const sendIcon = document.getElementById('sendIcon');
        const sendText = document.getElementById('sendText');

        if (!sendBtn || !sendIcon || !sendText) {
            console.error('æ— æ³•æ‰¾åˆ°å‘é€æŒ‰é’®å…ƒç´ ');
            showStatus('âŒ é¡µé¢å…ƒç´ é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            return;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        sendBtn.disabled = true;
        sendIcon.textContent = 'â³';
        sendText.textContent = 'å‘é€ä¸­...';

        // æ”¶é›†è¡¨å•æ•°æ®
        const fromEmail = document.getElementById('fromEmail');
        const toEmail = document.getElementById('toEmail');
        const emailSubject = document.getElementById('emailSubject');
        const emailBody = document.getElementById('emailBody');

        if (!fromEmail || !toEmail || !emailSubject || !emailBody) {
            console.error('æ— æ³•æ‰¾åˆ°è¡¨å•å…ƒç´ ');
            showStatus('âŒ è¡¨å•é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            return;
        }

        const formData = {
            from_email: fromEmail.value,
            to_email: toEmail.value,
            subject: emailSubject.value,
            body: emailBody.value
        };

        console.log('è¡¨å•æ•°æ®:', formData);

        // è¡¨å•éªŒè¯
        if (!formData.from_email) {
            showStatus('âŒ è¯·é€‰æ‹©å‘ä»¶äººé‚®ç®±', 'error');
            sendBtn.disabled = false;
            sendIcon.textContent = 'ğŸ“¤';
            sendText.textContent = 'å‘é€é‚®ä»¶';
            return;
        }

        if (!formData.to_email) {
            showStatus('âŒ è¯·è¾“å…¥æ”¶ä»¶äººé‚®ç®±', 'error');
            sendBtn.disabled = false;
            sendIcon.textContent = 'ğŸ“¤';
            sendText.textContent = 'å‘é€é‚®ä»¶';
            return;
        }

        if (!formData.subject) {
            showStatus('âŒ è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜', 'error');
            sendBtn.disabled = false;
            sendIcon.textContent = 'ğŸ“¤';
            sendText.textContent = 'å‘é€é‚®ä»¶';
            return;
        }

        if (!formData.body) {
            showStatus('âŒ è¯·è¾“å…¥é‚®ä»¶å†…å®¹', 'error');
            sendBtn.disabled = false;
            sendIcon.textContent = 'ğŸ“¤';
            sendText.textContent = 'å‘é€é‚®ä»¶';
            return;
        }

        // æ·»åŠ å¯é€‰å­—æ®µ
        const replyTo = document.getElementById('replyTo').value;
        const priority = document.getElementById('priority').value;

        if (replyTo) {
            formData.reply_to = replyTo;
        }

        if (priority !== 'normal') {
            formData.priority = priority;
        }

        try {
            showStatus('ğŸ“¤ æ­£åœ¨å‘é€é‚®ä»¶...', 'info');

            console.log('å‘é€APIè¯·æ±‚åˆ°: /api/send-email');
            console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(formData, null, 2));

            const response = await fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            console.log('APIå“åº”çŠ¶æ€:', response.status);
            console.log('APIå“åº”å¤´:', [...response.headers.entries()]);

            const result = await response.json();
            console.log('APIå“åº”æ•°æ®:', result);

            if (response.ok) {
                const recipientsText = Array.isArray(result.to) ? result.to.join(', ') : result.to;
                showStatus(`âœ… é‚®ä»¶å‘é€æˆåŠŸï¼\\n\\nğŸ“§ å‘ä»¶äºº: ${result.from}\\nğŸ‘¤ æ”¶ä»¶äºº: ${recipientsText}\\nğŸ“„ ä¸»é¢˜: ${result.subject}`, 'success');

                // æ¸…ç©ºè¡¨å•
                clearForm();

                // è®°å½•å‘é€å†å²
                saveSendHistory({
                    sent_at: new Date().toISOString(),
                    from: result.from,
                    requested_from: result.result?.requested_from || result.from,
                    to: Array.isArray(result.to) ? result.to : [result.to],
                    subject: result.subject
                });

                // åˆ·æ–°å‘é€å†å²
                loadSendHistory();

            } else {
                showStatus(`âŒ å‘é€å¤±è´¥: ${result.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                // å¦‚æœæ˜¯SMTPç›¸å…³é”™è¯¯ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
                if (result.detail && (result.detail.includes('SMTP') || result.detail.includes('è®¤è¯') || result.detail.includes('è¿æ¥'))) {
                    showSmtpHint();
                }
            }

        } catch (error) {
            console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showStatus('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            } else {
                showStatus('âŒ å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
            }
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            sendBtn.disabled = false;
            sendIcon.textContent = 'ğŸ“¤';
            sendText.textContent = 'å‘é€é‚®ä»¶';
        }
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
        document.getElementById('sendEmailForm').reset();
        hideStatus();
    }

    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('sendStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');

        statusText.innerHTML = message.replace('\\n', '<br>');

        // è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
        switch (type) {
            case 'success':
                statusIcon.textContent = 'âœ…';
                statusDiv.style.background = 'linear-gradient(45deg, var(--success-color), #4caf50)';
                break;
            case 'error':
                statusIcon.textContent = 'âŒ';
                statusDiv.style.background = 'linear-gradient(45deg, var(--error-color), #f44336)';
                break;
            case 'warning':
                statusIcon.textContent = 'âš ï¸';
                statusDiv.style.background = 'linear-gradient(45deg, var(--warning-color), #ff9800)';
                break;
            default:
                statusIcon.textContent = 'â„¹ï¸';
                statusDiv.style.background = 'linear-gradient(45deg, var(--info-color), #2196f3)';
        }

        statusDiv.style.display = 'block';

        // è‡ªåŠ¨éšè—æˆåŠŸå’Œè­¦å‘Šæ¶ˆæ¯
        if (type === 'success' || type === 'warning') {
            setTimeout(() => {
                hideStatus();
            }, 5000);
        }
    }

    // éšè—çŠ¶æ€æç¤º
    function hideStatus() {
        document.getElementById('sendStatus').style.display = 'none';
    }

    // æ˜¾ç¤ºSMTPé…ç½®æç¤º
    function showSmtpHint() {
        document.getElementById('smtpConfigHint').style.display = 'block';
    }

    // éšè—SMTPé…ç½®æç¤º
    function hideSmtpHint() {
        document.getElementById('smtpConfigHint').style.display = 'none';
    }

    function loadLocalHistory() {
        try {
            const raw = localStorage.getItem(SEND_HISTORY_KEY);
            if (!raw) {
                return [];
            }
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
            console.warn('è¯»å–å‘é€å†å²å¤±è´¥:', error);
            return [];
        }
    }

    function persistLocalHistory(entries) {
        try {
            localStorage.setItem(SEND_HISTORY_KEY, JSON.stringify(entries.slice(0, 10)));
        } catch (error) {
            console.warn('ä¿å­˜å‘é€å†å²å¤±è´¥:', error);
        }
    }

    function renderSendHistory(entries) {
        const container = document.getElementById('sendHistory');
        if (!container) {
            return;
        }

        if (!entries.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“¤</div>
                    <div class="empty-state-title">æš‚æ— å‘é€è®°å½•</div>
                    <div class="empty-state-description">å‘é€é‚®ä»¶åä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºå‘é€å†å²</div>
                </div>
            `;
            return;
        }

        const fragment = document.createDocumentFragment();

        entries.slice(0, 5).forEach(entry => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.cssText = 'padding: 0.75rem 0; border-bottom: 1px solid rgba(0,0,0,0.05);';

            const requestedInfo = entry.requested_from && entry.requested_from !== entry.from
                ? `ï¼ˆè¯·æ±‚: ${entry.requested_from}ï¼‰`
                : '';

            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${entry.subject || 'æ— ä¸»é¢˜'}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted-color); margin-top: 0.25rem;">
                            <div>å‘ä»¶äºº: ${entry.from} ${requestedInfo}</div>
                            <div>æ”¶ä»¶äºº: ${entry.to.join(', ')}</div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted-color); white-space: nowrap;">
                        ${AppUtils.formatRelativeTime(entry.sent_at)}
                    </div>
                </div>
            `;

            fragment.appendChild(item);
        });

        container.innerHTML = '';
        container.appendChild(fragment);
    }

    function saveSendHistory(record) {
        const history = loadLocalHistory();
        history.unshift(record);
        persistLocalHistory(history);
        renderSendHistory(history);
    }

    function loadSendHistory() {
        const history = loadLocalHistory();
        renderSendHistory(history);
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter å‘é€é‚®ä»¶
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('sendEmailForm').dispatchEvent(new Event('submit'));
        }

        // ESC éšè—çŠ¶æ€æç¤º
        if (e.key === 'Escape') {
            hideStatus();
        }
    });

    // è¡¨å•éªŒè¯å¢å¼º
    document.getElementById('toEmail').addEventListener('input', function(e) {
        const emails = e.target.value.split(',').map(email => email.trim());
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        for (const email of emails) {
            if (email && !emailRegex.test(email)) {
                e.target.setCustomValidity('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼Œå¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”');
                return;
            }
        }
        e.target.setCustomValidity('');
    });
</script>
{% endblock %}
